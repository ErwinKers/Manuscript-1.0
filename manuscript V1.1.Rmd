---
title: "Manuscript"
author: "Erwin Kers"
date: "01-09-2022"
output:
  html_notebook: default
  pdf_document: default
  html_document: default
---

Important! set working directory to where you saved the data/ R script

```{r}

#working directory
setwd("C:/Users/Erwin/OneDrive/Manuscript Erwin Kers/R script + data/Manuscript-1.0")

#change time to english for correct labels
Sys.setlocale("LC_TIME", "English")

#libraries for all following plots
library(oce)
library(lubridate)
library(reshape2)
library(MBA)
library(mgcv)
library(plyr)
library(tidyverse)
library(dplyr)
library(cowplot)
library(readxl)
library(ggthemes)

```

## CTD plots

```{r echo=FALSE, fig.align=, fig.height=6, fig.keep='all', fig.width=10, message=FALSE, warning=FALSE, paged.print=FALSE, results='hide'}
# general: plotting the CTD data

#Tidying the data frames

# Formatted the data files selected:
  # downcast
  # correct series
  # removed everything above -0.1 m depth

# Tidying datafile #1 27-oct-2020 ----

#as a pipe (O2_sat, O2_mgL)
CTD_oct <- read_csv2("Data/CTD Takvatn/CTD 1335 291020.csv", skip =4) %>%
  # remove the downcast
  filter( Ser == 2)%>%
  slice(c(1:131))%>% # selecting the downcast
  select(Press, Temp, 'OpOx',Opmgl,Date,Time,"F")%>%
  rename(depth = "Press", 
         temperature = "Temp",
         fluorescence = "F",
         oxygen_sat = "OpOx",
         oxygen_mgL = "Opmgl",
         date = "Date")%>%
  mutate(depth = -as.numeric(depth), 
         temperature = as.numeric(temperature),
         fluorescence = as.numeric(fluorescence),
         oxygen_sat = as.numeric(oxygen_sat),
         oxygen_mgL = as.numeric(oxygen_mgL))



# Tidying datafile #2 24-nov-2020 ----

CTD_nov <- read_csv2("Data/CTD Takvatn/CTD 1335 261120.csv", skip =4) %>%
  filter( Ser == 1)%>%
  slice(c(1:168))%>% # selecting the downcast
  select(Press, Temp,  'OpOx %',"Opmg/l",Date,Time,"F (?g/l)")%>%
  rename(depth = "Press", 
         temperature = "Temp",
         fluorescence = "F (?g/l)",
         oxygen_sat = "OpOx %",
         oxygen_mgL = "Opmg/l",
         date = 	Date)%>%
  mutate(depth = -as.numeric(depth), 
         temperature = as.numeric(temperature),
         fluorescence = as.numeric(fluorescence),
         oxygen_sat = as.numeric(oxygen_sat),
         oxygen_mgL = as.numeric(oxygen_mgL))



# Tidying datafile #3 15-jan-2021 ----

CTD_jan <- read_csv2("Data/CTD Takvatn/CTD 1335 200121.csv", skip =4) %>%
  filter( Ser == 1)%>%
  slice(c(1:226))%>% # selecting the downcast
  select(Press, Temp, 'OpOx %',"Opmg/l",Date,Time,"F (?g/l)")%>%
  rename(depth = "Press", 
         temperature = "Temp",
         fluorescence = "F (?g/l)",
         oxygen_sat = "OpOx %",
         oxygen_mgL = "Opmg/l",
         date = 	Date)%>%
  mutate(depth = -as.numeric(depth), 
         temperature = as.numeric(temperature),
         fluorescence = as.numeric(fluorescence),
         oxygen_sat = as.numeric(oxygen_sat),
         oxygen_mgL = as.numeric(oxygen_mgL))



# Tidying datafile #4 05-feb-2021 ----

CTD_feb <- read_csv2("Data/CTD Takvatn/CTD 1350 080221.csv", skip =4) %>%
  filter( Ser == 2)%>%
  slice(c(1:654))%>% # selecting the downcast
  select(Press, Temp, 'OpOx %',"Opmg/l",Date,Time,"F (?g/l)")%>%
  rename(depth = "Press", 
         temperature = "Temp",
         fluorescence = "F (?g/l)",
         oxygen_sat = "OpOx %",
         oxygen_mgL = "Opmg/l",
         date = 	Date)%>%
  mutate(depth = -as.numeric(depth), 
         temperature = as.numeric(temperature),
         fluorescence = as.numeric(fluorescence),
         oxygen_sat = as.numeric(oxygen_sat),
         oxygen_mgL = as.numeric(oxygen_mgL))



# Tidying datafile #5 18-mar-2021 ----

CTD_mar <- read.csv2("Data/CTD Takvatn/CTD 1350 180321.csv", skip =3) %>%
  filter( Ser == 1)%>%
  slice(c(1:148))%>% # selecting the downcast
  select(Press, Temp, 'OpOx..',"Opmg.l",Date,Time,"F..μg.l.")%>%
  rename(depth = "Press", 
         temperature = "Temp",
         fluorescence = "F..μg.l.",
         oxygen_sat = "OpOx..",
         oxygen_mgL = "Opmg.l",
         date = 	Date)%>%
  mutate(depth = -as.numeric(depth), 
         temperature = as.numeric(temperature),
         fluorescence = as.numeric(fluorescence),
         oxygen_sat = as.numeric(oxygen_sat),
         oxygen_mgL = as.numeric(oxygen_mgL))



# Tidying datafile #6 19-apr-2021 ----

#as a pipe (O2_sat, O2_mgL)
CTD_apr <- read.csv2("Data/CTD Takvatn/Winterlakes 19.04.21.csv", skip =31) %>%
  slice(-c(1))%>%
  slice(c(1:1061))%>% # selecting the downcast
  select(Press, Temp, 'Ri.O2',DO_mg,IntT,IntD,ChlAS)%>%
  rename(depth = "Press", 
         temperature = "Temp",
         fluorescence = "ChlAS",
         oxygen_sat = "Ri.O2",
         oxygen_mgL = "DO_mg",
         date = 	"IntT",
          Time = "IntD") %>%
  mutate(depth = -as.numeric(depth), 
         temperature = as.numeric(temperature),
         fluorescence = as.numeric(fluorescence),
         oxygen_sat = as.numeric(oxygen_sat),
         oxygen_mgL = as.numeric(oxygen_mgL))



# Tidying datafile #7 04-may-2021 ----

CTD_may1 <- read.csv2("Data/CTD Takvatn/CTD 1363 060521.csv", skip =4) %>%
  filter( Ser == 1)%>%
  slice(c(1:237))%>% # selecting the downcast
  select(Press, Temp, 'Ox..',"mg.l",Date,Time,"F...g.l.")%>%
  rename(depth = "Press", 
         temperature = "Temp",
         fluorescence = "F...g.l.",
         oxygen_sat = "Ox..",
         oxygen_mgL = "mg.l",
         date = 	Date)%>%
  mutate(depth = -as.numeric(depth), 
         temperature = as.numeric(temperature),
         fluorescence = as.numeric(fluorescence),
         oxygen_sat = as.numeric(oxygen_sat),
         oxygen_mgL = as.numeric(oxygen_mgL))%>%
  mutate(depth = depth * 1.4) # CTD depth measurements wrong trying to correct




# Tidying datafile #8 19-may-2021 ----

CTD_may2 <- read.csv2("Data/CTD Takvatn/Copy of CTD 1350 200521.csv", skip =4) %>%
  filter( Ser == 1)%>%
  slice(c(1:219))%>% # selecting the downcast
  select(Press, Temp, 'OpOx..',"Opmg.l",Date,Time,"F...g.l.")%>%
  rename(depth = "Press", 
         temperature = "Temp",
         fluorescence = "F...g.l.",
         oxygen_sat = "OpOx..",
         oxygen_mgL = "Opmg.l",
         date = 	Date)%>%
  mutate(depth = -as.numeric(depth), 
         temperature = as.numeric(temperature),
         fluorescence = as.numeric(fluorescence),
         oxygen_sat = as.numeric(oxygen_sat),
         oxygen_mgL = as.numeric(oxygen_mgL))




# Tidying datafile #9 08-jun-2021 ----

CTD_jun <- read.csv2("Data/CTD Takvatn/Copy of CTD 1350 080621.csv", skip =4) %>%
  filter( Ser == 1)%>%
  slice(c(1:154))%>% # selecting the downcast
  select(Press, Temp, 'OpOx..',"Opmg.l",Date,Time,"F...g.l.")%>%
  rename(depth = "Press", 
         temperature = "Temp",
         fluorescence = "F...g.l.",
         oxygen_sat = "OpOx..",
         oxygen_mgL = "Opmg.l",
         date = 	Date)%>%
  mutate(depth = -as.numeric(depth), 
         temperature = as.numeric(temperature),
         fluorescence = as.numeric(fluorescence),
         oxygen_sat = as.numeric(oxygen_sat),
         oxygen_mgL = as.numeric(oxygen_mgL))



# Make one dataset ----

# making the combined dataframe
ctd <- rbind(CTD_nov,CTD_oct,CTD_jan,CTD_feb,CTD_mar,CTD_apr,CTD_may1,CTD_may2,CTD_jun)%>%
  mutate(date = as.POSIXct(date,format="%d-%m-%Y"))
  
# Saving the new clean/combined data
#write.csv(ctd,"C:/Users/Erwin/OneDrive/Manuscript Erwin Kers/R script + data/Data", row.names = FALSE)

# Manually extracted hexidecimal ODV colour palette
ODV_colours <- c("#feb483", "#d31f2a", "#ffc000", "#27ab19", "#0db5e6", "#7139fe", "#d16cfa")

#The date column must then be converted to numeric values
ctd <- ctd %>%
  mutate(date = as.POSIXct(date,format="%d-%m-%Y"))



# 1. Heat map temperature ----

ctd_mba <- ctd %>%
  filter(depth < -0.1)%>%
  mutate(date = as.POSIXct(date,format="%d-%m-%Y")) %>%
  mutate(date = decimal_date(date))%>%
  select(date,depth,temperature)%>%
  mba.surf(no.X = 300, no.Y = 300, extend = T)

dimnames(ctd_mba$xyz.est$z) <- list(ctd_mba$xyz.est$x, ctd_mba$xyz.est$y)

ctd_mba <- melt(ctd_mba$xyz.est$z, varnames = c('date', 'depth'), value.name = 'temperature') %>% 
  filter(depth < -0.1) %>% 
  mutate(temp = round(temperature, 1))
#
ctdsub <- ctd %>%
  mutate(date = as.Date(date))%>%
  select(date,depth,temperature)
# colors for the plot
Temp_col <- c("red","purple", "light blue")

# Finally we create our gridded result
p1 <- ctd_mba %>%
  mutate(date = date_decimal(date))%>%
  mutate(date = as.Date(date))%>%
  ggplot(aes(x = date, y = depth)) +
  geom_raster(aes(fill = temp)) +
  scale_fill_gradientn(colours = rev(Temp_col)) +
  geom_contour(aes(z = temp), binwidth = 0.1, colour = "black", alpha = 0.2) +
  geom_contour(aes(z = temp), breaks = 20, colour = "black")+
    ### Activate to see which pixels are real and not interpolated
   geom_point(data = ctdsub, aes(x = date, y = depth),
             colour = 'black', size = 0.5, alpha = 0.4, shape = 8) +
  labs(y = "depth (m)", x = NULL, fill = "Temp. (°C)") +
  coord_cartesian(expand = 0)+
    scale_x_date (breaks="month", labels = scales::label_date("%b"))

# 2. heat map fluorescence ----
ctd_mba <- ctd %>%
  filter(depth < -0.1,fluorescence < 1)%>% # removes 2 observations (hit the bottom) 
  mutate(date = as.POSIXct(date,format="%d-%m-%Y")) %>%
  mutate(date = decimal_date(date))%>%
  select(date,depth,fluorescence)%>%
  mba.surf(no.X = 300, no.Y = 300, extend = T)

dimnames(ctd_mba$xyz.est$z) <- list(ctd_mba$xyz.est$x, ctd_mba$xyz.est$y)

ctd_mba <- melt(ctd_mba$xyz.est$z, varnames = c('date', 'depth'), value.name = 'fluorescence') %>% 
  filter(depth < -0.1,fluorescence < 1) %>% 
  mutate(temp = round(fluorescence, 1))
#
ctdsub <- ctd %>%
  filter(depth < -0.1,fluorescence < 1)%>%
  mutate(date = as.Date(date))%>%
  select(date,depth,fluorescence)

# colors for plot
Fluo_col <- c("darkgreen", "green", "white")

# Create fluorescence plot
p2 <- ctd_mba %>%
  mutate(date = date_decimal(date))%>%
  mutate(date = as.Date(date))%>%
  ggplot(aes(x = date, y = depth)) +
  geom_raster(aes(fill = temp)) +
  scale_fill_gradientn(colours = rev(Fluo_col)) +
  geom_contour(aes(z = temp), binwidth = 0.05, colour = "black", alpha = 0.3) +
  geom_contour(aes(z = temp), breaks = 20, colour = "black") +
  ### Activate to see which pixels are real and not interpolated
  geom_point(data = ctdsub, aes(x = date, y = depth),
             colour = 'black', size = 0.2, alpha = 0.4, shape = 8) +
  ###
  labs(y = "depth (m)", x = "date", fill = "Fluor (µg/l)") +
  coord_cartesian(expand = 0)+
  scale_x_date (breaks="month", labels = scales::label_date("%b"))

# 3. oxygen sat map ----

ctd <- rbind(CTD_nov,CTD_oct,CTD_jan,CTD_feb,CTD_mar,CTD_apr,CTD_may2,CTD_jun)%>%
  mutate(date = as.POSIXct(date,format="%d-%m-%Y"))

ctd_mba <- ctd %>%
  filter(depth < -0.1)%>% # removes air observations
  #filter(date == "2021-05-04")%>%
  mutate(date = as.POSIXct(date,format="%d-%m-%Y")) %>%
  mutate(date = decimal_date(date))%>%
  select(date,depth,oxygen_sat)%>%
  mba.surf(no.X = 300, no.Y = 300, extend = T)

dimnames(ctd_mba$xyz.est$z) <- list(ctd_mba$xyz.est$x, ctd_mba$xyz.est$y)

ctd_mba <- melt(ctd_mba$xyz.est$z, varnames = c('date', 'depth'), value.name = 'oxygen_sat') %>% 
  filter(depth < -0.1) %>% 
  mutate(temp = round(oxygen_sat, 1))
#
ctdsub <- ctd %>%
  mutate(date = as.Date(date))%>%
  filter(depth < -0.1)%>%
  select(date,depth,oxygen_sat)


# colours for plot
oxy_col <- c("blue"," light blue", "orange", "red")

# Create oxygen plot (oxygen sensor error removed)
p4 <- ctd_mba %>%
  mutate(date = date_decimal(date))%>% # convert to normal date for x axis
  mutate(date = as.Date(date))%>%
  ggplot(aes(x = date, y = depth)) +
  geom_raster(aes(fill = temp)) +
  scale_fill_gradientn(colours = rev(oxy_col)) +
  geom_contour(aes(z = temp), binwidth = 0.5, colour = "black", alpha = 0.2) +
  geom_contour(aes(z = temp), breaks = 20, colour = "black") +
  ### Activate to see which pixels are real and not interpolated
  geom_point(data = ctdsub, aes(x = date, y = depth),
             colour = 'black', size = 0.2, alpha = 0.4, shape = 8) +
  ###
  labs(y = "depth (m)", x = "date", fill = "oxygen %") +
  coord_cartesian(expand = 0) +
  scale_x_date (breaks="month", labels = scales::label_date("%b"))

## combine plots ----
plot_grid(p1, p2,p4, labels = c('A', 'B', "C"))

```

## Environmental observations

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 4, fig.width = 8, fig.align = "center"}
#conditions

cond <- read_excel("Data/Environmental observations.xlsx")
#cond #just showing off the table

# barplot
# Ice below line, snow on top of line, include light data
cond$Datefix <-as.POSIXct(cond$Date,format="%d-%m-%Y%H:%M")

#barplot
condbar <-cond %>%
  mutate_at("Ice thickness (cm)", funs(. * -1)) %>%
  #mutate(.,Date=as.Date(Date)) %>%
  pivot_longer(., cols = "Snow depth (cm)"  :"Ice thickness (cm)", names_to = "Type", values_to = "values")%>%
  ggplot(., aes(x= Datefix, y=values, fill= Type)) + 
  geom_bar(stat="identity") +
  labs( y = "Depth cm")+
xlim(c(as.POSIXct('2020-11-20 08:09', format = "%Y-%m-%d %H:%M"),
     as.POSIXct('2021-07-15 17:31', format = "%Y-%m-%d %H:%M"))) +
  geom_text(aes(label=values), position = position_stack(vjust= 0.5),
            colour = "white", size = 2)+
geom_hline(yintercept=0, linetype="dashed", color = "black")+
scale_fill_manual(values=c("light blue", "grey")) 
#possible to theme
 # theme_tufte()
  
condbar
```



## light sensor data (might not include in paper?)

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 4, fig.width = 8, fig.align = "center"}
water <- read.csv2("Data/WATER sensor.csv")

library(lubridate)

### specify date format to use in graph
water$Datefix <-as.POSIXct(water$Date,format="%d-%m-%Y%H:%M")

##check if right class/format
class(water$Datefix)
str(water$Date)

## subset air and water sensor
sub.water <-subset(water,Zone=="WATER")
sub.air <-subset(water,Zone=="AIR")

#GGplot
light <- ggplot(sub.water,aes(Datefix,divided.10000))+
  geom_line()+
  geom_point(data = sub.air)+
  labs(title="Under ice light availability", y = "Quantum [umol/(m^2s)]",x = "Month") +
xlim(c(as.POSIXct('2021-02-05 08:09', format = "%Y-%m-%d %H:%M"),
     as.POSIXct('2021-06-08 17:31', format = "%Y-%m-%d %H:%M")))

 light
 
 # to visualize the whole experiment (missing data)
 # xlim(c(as.POSIXct('2020-11-20 08:09', format = "%Y-%m-%d %H:%M"),
 #    as.POSIXct('2021-07-15 17:31', format = "%Y-%m-%d %H:%M")))
 
 #scale_x_datetime(breaks="month",limits = as_datetime(c('2020-11-20 08:09:00','2021-07-15 17:31:00')),labels = scales::label_date("%b"))
 
```

## Nutrient data

```{r echo=FALSE,results='hide', fig.height = 4, fig.width = 8, fig.align = "center"}
library(readxl)
library(dplyr)
library(tidyverse)
library(ggbreak)
nutrient <- read_excel("Data/nutrient data.xlsx")


#Nutrients
barnut4 <- nutrient %>% slice(26:43) %>% 
  rename(Phosphate = "Fosfat",
         "Nitrate + Nitrite" = "Nitritt+Nitrat",
         Silicate = "Silikat")%>%
  pivot_longer(cols = Ammonium:Silicate, names_to = "Nutrient", values_to = "values") %>%
    mutate(Nutrient = fct_reorder(Nutrient, values, .fun='median')) %>%
  mutate(Date = as.Date(Date))%>%
  mutate(Nedre_dyp = as.character(Nedre_dyp))%>%
  ggplot(., aes(x = Date, y = values, fill = Nedre_dyp)) +
  geom_bar(position = "dodge",stat="identity") +
  scale_x_date(breaks="month", labels = scales::label_date("%b"),limits = as.Date(c('2020-10-20','2021-06-15'))) +
  labs(title="Nutrients", y = "µg/L") +
scale_fill_discrete(name = "Depth", labels = c("10m","58m"))+
facet_wrap(~Nutrient, scales="free")
barnut4

```

## Chlorophyll A data

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 4, fig.width = 8, fig.align = "center"}

# CHl-a Data
# graphs overtime
library(readxl)
library(tidyverse)
library(cowplot)
Chla <- read_excel("Data/Chl-a for R.xlsx")

Chla$Date <- as.Date(Chla$Date,
                     origin = "1899-12-30")

#barplot of chl2
chlbar <-filter(Chla, 
                 Sample == "Takvatn") %>%
  rename(chl ="Chl a (mg/m3)" )%>%
  ggplot(., aes(fill=Depth, y=chl, x= Date)) + 
  geom_bar(position="dodge", stat="identity")+
  labs(title="Chlorophyll a", y = "µg/L")+
  scale_x_date(breaks="month", labels = scales::label_date("%b"),limits = as.Date(c('2020-10-20','2021-06-15'))) + # note x axis longer otherwise bars dont fit
scale_fill_discrete(name = "Depth", labels = c("0m", "0-10m"))

chlbar
```

## Phytoplankton community

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 4, fig.width = 8, fig.align = "center"}
#phytoplankton community

phy <- read_excel("Data/Phytoplankton community.xlsx")
library(ggplot2)
library(tidyverse)
library(forcats)
library(ggthemes)
library(ggbreak)
phy$Date <- as.Date(phy$Date,
                     origin = "1899-12-30")
phy <-phy %>%
  mutate(.[c(5:12)]*100)

# with Cryptophytes
phybar2 <- phy %>% 
  filter( Location == "Takvatn") %>%
  pivot_longer(cols = Cryptophytes:Diatomea, names_to = "class", values_to = "values") %>%
  mutate(Date = as.Date(Date))%>%
  mutate(class = fct_reorder(class, values, .fun='median')) %>%
  ggplot(., aes(x = Date, y = values, fill = Depth )) +
  geom_bar(position = "Dodge",stat="identity") +
  scale_x_date(breaks="month", labels = scales::label_date("%b"),limits = as.Date(c('2020-10-20','2021-06-15'))) +
  labs(title="Phytoplankton composition", y = "N per liter")+
facet_wrap(~class, scales="free")

phybar2


```
## Rotifer composition

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 4, fig.width = 8, fig.align = "center"}

rotifer <- read_excel("Data/Rotifer data/rotifer.xlsx")

str(rotifer) # checking if variables are in the right format

# to calculate rotifers per net haul
ifelse(( rotifer[8:16]) > 0, (d <-(((rotifer$`sample(ml)`/rotifer$`subsample(ml)`)*rotifer[8:16])/rotifer$fraction)),0)
rotifer2 <- bind_cols(rotifer[1:7],d)


# plotting
plotrot <-filter(rotifer2, 
                 site == "Takvatn") %>%
  pivot_longer(., cols = "Keratella cochlearis"  :"Conochilus unicornis", names_to = "species", values_to = "values")%>%
    mutate(species = fct_reorder(species, values, .fun='median')) %>%
  ggplot(., aes(fill=species, y=values, x= date)) + 
  geom_bar(position="dodge", stat="identity")+
  labs(title="Rotifer composition", y = " N per net haul")

plotrot

# stacked barplot
plotrot2 <-filter(rotifer2, 
                 site == "Takvatn") %>%
  pivot_longer(., cols = "Keratella cochlearis"  :"Conochilus unicornis", names_to = "species", values_to = "values")%>%
    mutate(species = fct_reorder(species, values, .fun='median')) %>%
  ggplot(., aes(fill=species, y=values, x= date)) + 
  geom_bar(position="stack", stat="identity")+
  labs(title="Rotifer composition", y = " N per net haul")

plotrot2


rotiferplot <- rotifer2 %>% 
  filter( site == "Takvatn") %>%
  pivot_longer(., cols = "Keratella cochlearis"  :"Conochilus unicornis", names_to = "species", values_to = "values") %>%
     mutate(species = fct_reorder(species, values, .fun='median')) %>%
    mutate(date = as.Date(date))%>%
  ggplot(., aes(x = date, y = values, fill = species )) +
  geom_bar(position = "Dodge",stat="identity") +
  scale_x_date(breaks="month", labels = scales::label_date("%b"),limits = as.Date(c('2020-10-20','2021-06-15'))) +
  labs(title="Rotifer composition", y = "N per liter")+
facet_wrap(~species, scales="free")

rotiferplot

```

## Zooplankton Biomass

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 4, fig.width = 8, fig.align = "center"}
library(forcats)
library(ggplot2)

### Biomass zooplankton
Biom <-read.csv2("Data/Zooplankton Biomass.csv")


### to get right date format
Biom$Datefix <- as.Date(Biom$Date,
                        origin = "1899-12-30")

# Stacked barplot
Biom <- subset(Biom,Depth !="60-20")
# merge depth and mesh size together

Biom$Depth <- as.numeric(Biom$Depth)

biombar <- Biom %>%
  subset(.,Net_size == "90") %>%
  #mutate(Volume = if_else(Depth == 60 , 4241.15, 1413.72)) %>%# calculating volume filtered trough net
  mutate(., new = X.fraction/Depth)%>%
  mutate(Depth=as.character(Depth))%>%
  mutate(Depth = fct_reorder(Depth, new)) %>%
  mutate(., new= new*1000)%>% #to change gram to mg
  ggplot(., aes(fill=Depth, y=new, x= Datefix)) + 
  geom_bar(position="dodge", stat="identity")+
  labs(title="Zooplankton biomass", y = "mg DW per vertical meter", x= "Date")+
  scale_x_date(breaks="month", labels = scales::label_date("%b"),limits = as.Date(c('2020-10-20','2021-06-15')))+ # note x axis longer otherwise bars dont fit 
  #theme_tufte()
 scale_fill_discrete(name = "Depth", labels = c("20-0m", "60-0m"))

biombar
```

## Zooplankton community

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 4, fig.width = 8, fig.align = "center"}
Zoopcomp <- read.csv2("Data/Zooplankton ID complete.csv")

library(ggplot2)
library(ggthemes)

## fixing the date format
Zoopcomp$Datefix <- as.Date(Zoopcomp$Date,
                            origin = "1899-12-30")
Sys.setlocale(category = "LC_ALL", locale = "english")
# add adult eudiaptomus together
Zoopcomp$Adult_Eud <- (Zoopcomp$tot.F.eud+Zoopcomp$E.G.M)

# in vertical meter hauled since exact volume is not known
#recalculating zooplankton per vertical M hauled
q <- Zoopcomp %>% 
  slice(c(1:18))%>% 
  mutate(Depth=as.numeric(Depth))%>%
   mutate(Depth2 = if_else(Depth == 60 , "60-0 meters", "20-0 meters"))%>%
  # mutate(Volume = if_else(Depth == 60 , 4241.15, 1413.72)) %>%# calculating volume filtered trough net
  mutate_at(vars(Nauplii..:with.eggs),list(A=~./Depth))

  #Standardized

#EUDIAPTOMUS
E <- q %>%
  slice(c(1:18))%>%
  pivot_longer(cols = Calanoid.C4.C5_A:with.eggs_A, names_to = "stage", values_to = "count")%>%
  mutate(stage = fct_reorder(stage, count, .fun='median')) %>%
  ggplot(.,
       mapping = aes(x = Datefix, y = count, fill = stage)) +
  geom_bar(position="stack", stat="identity") +
  scale_x_date(breaks="month", labels = scales::label_date("%b"),limits = as.Date(c('2020-10-20','2021-06-15')))+
    facet_wrap(~Depth2)+ 
  labs(title="E. graciloides", y = "N per vertical meter", x= "")+
 scale_fill_discrete(name = "Legend", labels = c( "Female + eggs", "Female","Male","C4-C5")) +
theme(axis.text.x = element_text(angle = 90))
E
#CYCLOPS
C <- q %>%
  slice(c(1:18))%>%
  pivot_longer(cols =  Cyclopoid.C1.C3.._A:Cyclops.scutifer._A, names_to = "stage", values_to = "count")%>%
  mutate(stage = fct_reorder(stage, count, .fun='median')) %>%
  ggplot(.,
       mapping = aes(x = Datefix, y = count, fill = stage)) +
  geom_bar(position="stack", stat="identity") +
  scale_x_date(breaks="month", labels = scales::label_date("%b"),limits = as.Date(c('2020-10-20','2021-06-15')))+
    facet_wrap(~Depth2)+ 
  labs(title="C. scutifer", y = "N per vertical meter", x= "")+
 scale_fill_discrete(name = "Legend", labels = c( "Adults", "C1-C3","C4-C5"))+
theme(axis.text.x = element_text(angle = 90))
C

# Nauplii
N <- q %>%
  slice(c(1:18))%>%
  pivot_longer(cols =  Nauplii.._A, names_to = "stage", values_to = "count")%>%
  mutate(stage = fct_reorder(stage, count, .fun='median')) %>%
  ggplot(.,
       mapping = aes(x = Datefix, y = count, fill = stage)) +
  geom_bar(position="stack", stat="identity") +
  scale_x_date(breaks="month", labels = scales::label_date("%b"),limits = as.Date(c('2020-10-20','2021-06-15')))+
    facet_wrap(~Depth2)+ 
  labs(title="Nauplii", y = "N per vertical meter", x= "Date")+
 scale_fill_discrete(name = "Legend", labels = c( "Nauplii"))+
theme(axis.text.x = element_text(angle = 90))
N

#NAUPLII
#N <- q %>%
#  slice(c(1:18))%>%
#  mutate(Depth=as.character(Depth))%>%
#ggplot(.,
#       mapping = aes(x = Datefix, y = Nauplii.._A, fill = Depth ))+
#  geom_bar(position="dodge", stat="identity") +
#  scale_x_date(breaks="month", labels = scales::label_date("%b"),limits = as.Date(c('2020-10-20','2021-06-15')))+
#labs(title="Nauplii", y = "N per liter")+
#  facet_wrap(~Depth)+ 
# scale_fill_discrete(name = "Legend", labels = c( "20-0 meter", "60-0 meter"))
#N


```

### Combined zooplankton community

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 8, fig.width = 6, fig.align = "center"}
plot_grid(E,C,N,ncol=1,align = "v")
```

## Total lipids over time

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 4, fig.width = 8, fig.align = "center"}

library(readxl)
library(ggplot2)
library(tidyverse)
library(lubridate)
library(scales)
FA <- read_excel("Data/FA data.xlsx", skip=1)
#changing data format
FA$Date <- as.Date(FA$Date)

# recalculating POM in percent per Liter + bulkt tracers per net haul
# column: VOL contains the amount of filtered water for POM in liters
#   and the fraction of the net haul for Bulktracers
FA.mute <- FA %>% 
  mutate_at(c(12:66), ~ .x/ VOL)

Sys.setlocale("LC_TIME", "English") 
Filt <- filter(FA.mute, Species== "Cyclops" & Type == "μg FAME/mg dw" | Species== "Eudiaptomus" & Type == "μg FAME/mg dw") %>%
  filter(Date >= as.Date("2020-10-27"))

totlip <- ggplot(Filt, aes(x= Date, y= Tot_lipids, fill= Species,color=Species))+ 
  scale_x_date(breaks = scales::breaks_pretty(10)) +
  geom_point()+
  geom_smooth()+
  labs(title="Total lipids over time", y = "total lipids (mean) [mg/g]")+
  scale_x_date(breaks="month", labels = scales::label_date("%b"),limits = as.Date(c('2020-11-24','2021-06-08')))
totlip  

```

There is a large difference between the previous and next plot, in the Total lipids plot it seems Cyclops has an higher lipid content. When looking at the FA classes if you'd add them up Eudiaptomus has higher content of FAME. This makes me wonder is it normal to have such a difference between to two species in glycerol content? Is this purely due to the difference in storage and membrane lipds?

(or is there something beside the removal of glycerol that can cause this difference?)

## FA groups over time

```{r echo=FALSE,results='hide',fig.keep='all',fig.height = 4, fig.width = 8, fig.align = "center"}
FA <- read_excel("Data/FA data.xlsx", skip=1)
#changing data format
FA$Date <- as.Date(FA$Date)

# recalculating POM in percent per Liter + bulkt tracers per net haul
# column: VOL contains the amount of filtered water for POM in liters
#   and the fraction of the net haul for Bulktracers
FA.mute <- FA %>% 
  mutate_at(c(12:67), ~ .x/ VOL)


max <- as.Date("2021-07-10")
min <- as.Date("2020-11-15")

#make a facetwrap
FALIN <- FA.mute %>% 
  tidyr::gather("Legend", "value", 59:64) %>% 
  filter(., Species != "Blank" & Species != "Bulk tracers" & Type == "μg FAME/mg dw" )%>%
  filter(Date != as.Date("2020-10-27"))%>%
  ggplot(., aes(Date, value, fill= Legend,color=Legend))+
  scale_x_date(breaks = scales::breaks_pretty(10),limits=c(min, max)) +
  geom_point()+
  geom_smooth( se=T)+
  #scale_y_continuous(trans='log10') +
  labs(title="Fatty acid concentrations", y = "FAME μg/mg dryweight")+
 facet_wrap(~Species) 
FALIN

FABAR2 <- FA.mute %>% 
  tidyr::gather("Legend", "value", 59:64) %>% 
  filter(., Species != "Blank" & Species != "Bulk tracers" & Type == "μg FAME/mg dw" )%>%
  filter(Date != as.Date("2020-10-27"))%>%
  ggplot(., aes(Date, value, fill= Legend,color=Legend))+
  scale_x_date(breaks = scales::breaks_pretty(10),limits=c(min, max)) +
  geom_bar(position="stack", stat="identity")+
  #scale_y_continuous(trans='log10') +
  labs(title="ZFatty acid concentrations", y = "FAME μg/mg dryweight")+
 facet_wrap(~Species)
FABAR2
```

## FA per L of POM

```{r echo=FALSE,results='hide',fig.keep='all',fig.height = 4, fig.width = 8, fig.align = "center"}
library(readxl)
FA <- read_excel("Data/FA data.xlsx", skip=1)
#changing data format
FA$Date <- as.Date(FA$Date)

# recalculating POM in percent per Liter + bulkt tracers per net haul
# column: VOL contains the amount of filtered water for POM in liters
#   and the fraction of the net haul for Bulktracers

# not necessary anymore, VOL gets calculated in excel sheet (gravimetry)
#FA.mute <- FA %>% 
 # mutate_at(c(12:66), ~ .x/ VOL)

max <- as.Date("2021-07-10")
min <- as.Date("2020-11-15")


#make a facetwrap
FALIN2 <- FA %>% 
  tidyr::gather("Legend", "value", 59:64) %>% 
  filter(., Species != "Blank" & Species != "Bulk tracers" & Type == "μg FAME/L" )%>%
  filter(Date != as.Date("2020-10-27"))%>%
  mutate(Depth2 = if_else(Depth == "0-10" , "10-0 meters", "0 meters"))%>%
  ggplot(., aes(Date, value, fill= Legend,color=Legend))+
    scale_x_date(breaks = scales::breaks_pretty(10),limits=c(min, max)) +
  geom_point()+
  geom_line( se=T)+
  #scale_y_continuous(trans='log10') +
  labs(title="Fatty acid concentrations POM", y = "FAME μg/L")+
 facet_wrap(~Depth2)
FALIN2



FABAR <- FA %>% 
  tidyr::gather("Legend", "value", 59:64) %>% 
  filter(., Species != "Blank" & Species != "Bulk tracers" & Type == "μg FAME/L" )%>%
  filter(Date != as.Date("2020-10-27"))%>%
  mutate(Depth2 = if_else(Depth == "0-10" , "10-0 meters", "0 meters"))%>%
  ggplot(., aes(Date, value, fill= Legend,color=Legend))+
    scale_x_date(breaks = scales::breaks_pretty(10),limits=c(min, max)) +
  geom_bar(position="stack", stat="identity")+
  #scale_y_continuous(trans='log10') +
  labs(title="POM", y = "FAME μg/L")+
 facet_wrap(~Depth2)
FABAR

#### checking specific PUFA's
check <- FA %>% 
  tidyr::gather("Legend", "value", 35,39,41,47,50,52,57) %>% 
  filter(., Species != "Blank" & Species != "Bulk tracers" & Type == "μg FAME/L" )%>%
  filter(Date != as.Date("2020-10-27"))%>%
  mutate(Depth2 = if_else(Depth == "0-10" , "10-0 meters", "0 meters"))%>%
  ggplot(., aes(Date, value, fill= Legend,color=Legend))+
    scale_x_date(breaks = scales::breaks_pretty(10),limits=c(min, max)) +
  geom_point()+
  geom_line( se=T)+
  #scale_y_continuous(trans='log10') +
  labs(title="Fatty acid abundance POM", y = "FAME μg/L")+
 facet_wrap(~Depth2)
check


```

## Difference between total lipids and total FAME

```{r echo=FALSE,results='hide',fig.keep='all',fig.height = 4, fig.width = 8, fig.align = "center"}

FA %>% 
  rename(
     Total_FAME = tot_fame,
    Total_lipids = Tot_lipids)%>% 
  tidyr::gather("Legend", "value", 7,58) %>% 
  filter(., Species != "Blank" & Species != "Bulk tracers" & Type == "μg FAME/mg dw" )%>%
  filter(Date != as.Date("2020-10-27"))%>%
  ggplot(., aes(Date, value, fill= Legend,color=Legend))+
  scale_x_date(breaks = scales::breaks_pretty(10)) +
  geom_point()+
  geom_smooth( se=T)+
  #scale_y_continuous(trans='log10') +
  labs(title="Total FAME & Total Lipids", y = "μg/mg dryweight")+
 facet_wrap(~Species)

############## without total lipids

FA %>% 
  filter(., Species != "Blank" & Species != "Bulk tracers" & Type == "μg FAME/mg dw" )%>%
  filter(Date != as.Date("2020-10-27"))%>%
  ggplot(., aes(Date, tot_fame, fill= Species,color=Species))+
  scale_x_date(breaks = scales::breaks_pretty(10)) +
  geom_point()+
  geom_smooth( se=T)+
  #scale_y_continuous(trans='log10') +
  labs(title="Total FAME", y = "μg/mg dryweight")

```

## FAME % per grouped FA

```{r echo=FALSE,results='hide',fig.keep='all',fig.height = 6, fig.width = 8, fig.align = "center"}
FA <- read_excel("Data/FA data.xlsx", skip=1)
#changing data format
FA$Date <- as.Date(FA$Date)


#make a facetwrap
FA %>% 
  tidyr::gather("Legend", "value", 59:64) %>% 
  filter(., Species != "Blank" & Species != "Bulk tracers" & Type == "%" )%>%
  filter(Date != as.Date("2020-10-27"))%>%
  ggplot(., aes(Date, value, fill= Legend,color=Legend))+
  scale_x_date(breaks = scales::breaks_pretty(10)) +
  geom_point()+
  geom_smooth( se=F)+
  #scale_y_continuous(trans='log10') +
  labs(title="Fatty acid contributions", y = "FAME %")+
 facet_wrap(~Species)

FA %>% 
  tidyr::gather("Legend", "value", 35,39,41,47,50,52,57) %>% 
  filter(., Species != "Blank" & Species != "Bulk tracers" & Type == "μg FAME/mg dw" )%>%
  filter(Date != as.Date("2020-10-27"))%>%
  ggplot(., aes(Date, value, fill= Legend,color=Legend))+
  scale_x_date(breaks = scales::breaks_pretty(10)) +
  geom_point()+
  geom_smooth( se=T)+
  #scale_y_continuous(trans='log10') +
  labs(title="Main PUFA's", y = "μg FAME/mg dw")+
 facet_wrap(~Species)


FA %>% 
  tidyr::gather("Legend", "value", 33,35,37,39,41,42,44,46,47,49,50,52,54,55,56,57) %>% 
  filter(., Species != "Blank" & Species != "Bulk tracers" & Type == "μg FAME/mg dw" )%>%
  filter(Date != as.Date("2020-10-27"))%>%
  ggplot(., aes(Date, value, fill= Legend,color=Legend))+
  scale_x_date(breaks = scales::breaks_pretty(10)) +
  geom_point()+
  geom_smooth( se=T)+
  #scale_y_continuous(trans='log10') +
  labs(title=" Main PUFA's", y = "μg FAME/mg dw")+
 facet_wrap(~Species)

FA %>% 
  tidyr::gather("Legend", "value", 35,39,41,47,50,52,57) %>% 
  filter(., Species != "Blank" & Species != "Bulk tracers" & Type == "%" )%>%
  filter(Date != as.Date("2020-10-27"))%>%
  ggplot(., aes(Date, value, fill= Legend,color=Legend))+
  scale_x_date(breaks = scales::breaks_pretty(10)) +
  geom_point()+
  geom_smooth( se=F)+
  #scale_y_continuous(trans='log10') +
  labs(title="Main PUFA's", y = "% of total FAME")+
 facet_wrap(~Species)

FA %>% 
  tidyr::gather("Legend", "value",59,60,61) %>% 
  filter(., Species != "Blank" & Species != "Bulk tracers" & Type == "μg FAME/mg dw" )%>%
  filter(Date != as.Date("2020-10-27"))%>%
  ggplot(., aes(Date, value, fill= Legend,color=Legend))+
  scale_x_date(breaks = scales::breaks_pretty(10)) +
  geom_point()+
  geom_smooth( se=T)+
  #scale_y_continuous(trans='log10') +
  labs(title="Grouped fatty acids", y = "μg FAME/mg dw")+
 facet_wrap(~Species)

```

# added plot 2

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 8, fig.width = 8, fig.align = "center"}
library(ggbreak)
plot_grid(FALIN,FALIN2,ncol=1,align = "v")

```

# CA plots

## CA ALL (to appendix)

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 8, fig.width = 8, fig.align = "center"}


library(tidyverse)
library(readxl)
library(easyCODA)
FA.dat <- read_excel("Data/FA data.xlsx", skip=1)

# Selection of data 
# selecting only % for the 3 species
CA.1 <- filter(FA.dat, Type=="%", Species == "Eudiaptomus" |  Species == "Cyclops" | Species == "POM" & Depth == "0-10") %>%
  filter(Date != as.Date("2020-10-27"))%>%
filter(Date != as.Date("2021-06-30"))

# Selecting only FA to keep in analysis + species,date, vial to make column
CA.1 <- CA.1[c(1,3,5,12:57)]

################### fixing dates
dates <- CA.1$Date
table(dates)

dates.num <- as.numeric(as.factor(dates))
table(dates.num)

dates.lev <- factor(as.factor(dates), levels=c("2020-11-24", "2021-01-15", "2021-02-05","2021-03-18", "2021-04-19", "2021-05-04", "2021-05-19", "2021-06-08" ))
table(dates.lev)

dates.num <- as.numeric(dates.lev)
table(dates.num)

####################

#make a value for numbers of vial (removing "EK")
num.1 <- str_sub(CA.1$Vial, 3, str_length(CA.1$Vial)-0)

species <- (CA.1$Species)
#  make species as numbers instead of characters
species.num <- as.numeric(as.factor(CA.1$Species))

# add first letter of Species with number of vial together
case.label <- paste(substr(CA.1$Species,1,1), num.1, sep="")

#make rownames the vial column
CA.1 <-CA.1 %>% remove_rownames %>% column_to_rownames(var="Vial")

# set case.label value as rownames
rownames(CA.1) <- case.label

#remove species & date column + FA with many 0's (9,10D16 and C20:1n-9, whch have too many zeros, also C19:0internalstandard)
ER <- CA.1[,-c(1,2,15, 23, 29)]

############################################# FANCY

FA2E    <- ER
FA2E.ca <- CA(FA2E)
# PLOT.CA(FA2E.ca, map="contribution", axes.inv=c(1,-1), rescale=0.5)
################################################################################


### remove outlier C57 and re-analyse

FA2 <- ER
FA2.ca <- CA(FA2)
# PLOT.CA(FA2.ca, map="contribution", axes.inv=c(1,-1), rescale=1.666666)


### better graphics
round(100*FA2.ca$sv^2/sum(FA2.ca$sv^2),2)


FA2.ca.rpc <- FA2.ca$rowpcoord
cm <- colSums(FA2)/sum(FA2)
FA2.ca.ccc <- FA2.ca$colcoord * sqrt(cm)

# invert 1st axis
FA2.ca.rpc[,1] <- -FA2.ca.rpc[,1]
FA2.ca.ccc[,1] <- -FA2.ca.ccc[,1]

FA2.ca.ctr <- (FA2.ca.ccc[,1]^2 > 1/ncol(FA2)) | (FA2.ca.ccc[,2]^2 > 1/ncol(FA2)) 
names(FA2.ca.ctr) <- colnames(FA2)
sum(FA2.ca.ctr)


# force 20:5n-3 into the plot
FA2.ca.ctr["C20:5n-3"] <- TRUE

### function add.alpha:
add.alpha <- function(col, alpha=1){
  if(missing(col))
    stop("Please provide a vector of colours.")
  apply(sapply(col, col2rgb)/255, 2, 
        function(x) 
          rgb(x[1], x[2], x[3], alpha=alpha))  
}
### 
require(RColorBrewer)
species.col <- brewer.pal(3, "Dark2") # c("forestgreen","chocolate","purple) # green for "C", brown for "E"

species.col.alpha <- add.alpha(species.col, 0.8)

require(colorspace)
date.col <- rainbow_hcl(9)
require(RColorBrewer)
date.col <- c(brewer.pal(8, "Dark2"),brewer.pal(8,"Dark2")[1])
species.col.alpha <- add.alpha(species.col, 0.8)

# save as png insert into PPT, and eventually save all as png
#png(file="Fig_S6_left.png",width=7,height=5.5,units="in",res=144)

rescale <- 0.5 # for points
dim <- c(1,2)
col <- c("blue","red")
perc.hor <- 64.77; perc.ver <- 14.31
par(mar=c(4.2,4,2,2.5), mgp=c(2,0.7,0), font.lab=2, cex.axis=0.8)
plot(1.05 * rbind(FA2.ca.rpc, rescale*FA2.ca.ccc), type = "n", 
     asp = 1, xlab = paste("CA dimension ", dim[1], " (", 
                           round(perc.hor, 1), "%)", sep = ""), ylab = paste("CA dimension ", 
                                                                             dim[2], " (", round(perc.ver, 1), "%)", sep = ""), 
     xaxt = "n", yaxt = "n", main = "")
abline(h = 0, v = 0, col = "gray", lty = 2)
axis(1)
axis(2)
axis(3, at = axTicks(3), labels = round(axTicks(3)/rescale, 
                                        2), col = "black", col.ticks = col[2], col.axis = col[2])
axis(4, at = axTicks(4), labels = round(axTicks(4)/rescale, 
                                        2), col = "black", col.ticks = col[2], col.axis = col[2])

arrows(0, 0, 0.92 * rescale * FA2.ca.ccc[FA2.ca.ctr, 1], 0.92 * rescale * FA2.ca.ccc[FA2.ca.ctr, 2], 
       length = 0.1, angle = 10, col = "pink")
text(FA2.ca.rpc,  labels=paste(substr(species,1,1),dates.num, sep=""),
     col = date.col[dates.num],cex = 0.6, font=2)
text(rescale * FA2.ca.ccc[FA2.ca.ctr,], labels = colnames(FA2)[FA2.ca.ctr], col = "red", cex = 0.7, font = 4)    
legend("topleft", legend=c("1 = 24/11/2020","2 = 15/01/2021","3 = 05/02/2021",
                           "4 = 18/03/2021","5 = 19/04/2021","6 = 04/05/2021","7 = 19/05/2021","8 = 08/06/2021"), 
       col=date.col, text.col=date.col, cex=0.8, text.font=2, title="C:Cyclops E:Eudiaptomus P:POM", title.col="black")

################################## CCA

FA.cca1<-cca(FA2~species+dates)		# add species and dates as explanatory variables
plot(FA.cca1,scaling=3)

anova(FA.cca1, by = "margin") #or by terms, margin, axis

```

## CA Only Eudiaptoms

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 8, fig.width = 8, fig.align = "center"}


library(tidyverse)
library(readxl)
library(easyCODA)
FA.dat <- read_excel("Data/FA data.xlsx", skip=1)

# Selection of data 
# selecting only % for the 3 species
CA.1 <- filter(FA.dat, Type=="%", Species == "Eudiaptomus" ) %>%
  filter(Date != as.Date("2020-10-27"))

# Selecting only FA to keep in analysis + species,date, vial to make column
CA.1 <- CA.1[c(1,3,5,12:57)]

################### fixing dates
dates <- CA.1$Date
table(dates)

dates.num <- as.numeric(as.factor(dates))
table(dates.num)

dates.lev <- factor(as.factor(dates), levels=c("2020-11-24", "2021-01-15", "2021-02-05","2021-03-18", "2021-04-19", "2021-05-04", "2021-05-19", "2021-06-08" ))
table(dates.lev)

dates.num <- as.numeric(dates.lev)
table(dates.num)

####################

#make a value for numbers of vial (removing "EK")
num.1 <- str_sub(CA.1$Vial, 3, str_length(CA.1$Vial)-0)

species <- (CA.1$Species)
#  make species as numbers instead of characters
species.num <- as.numeric(as.factor(CA.1$Species))

# add first letter of Species with number of vial together
case.label <- paste(substr(CA.1$Species,1,1), num.1, sep="")

#make rownames the vial column
CA.1 <-CA.1 %>% remove_rownames %>% column_to_rownames(var="Vial")

# set case.label value as rownames
rownames(CA.1) <- case.label

#remove species & date column + FA with many 0's (9,10D16 and C20:1n-9, whch have too many zeros, also C19:0internalstandard)
ER <- CA.1[,-c(1,2,15, 23, 29)]

############################################# FANCY

### remove outlier C57 and re-analyse (not aplicable in eudiaptomus)

FA2E    <- ER
FA2E.ca <- CA(FA2E)
#PLOT.CA(FA2E.ca, map="contribution", axes.inv=c(1,-1), rescale=0.5)
################################################################################


### remove outlier C57 and re-analyse

FA2 <- ER
FA2.ca <- CA(FA2)
#PLOT.CA(FA2.ca, map="contribution", axes.inv=c(1,-1), rescale=1.666666)


### better graphics
round(100*FA2.ca$sv^2/sum(FA2.ca$sv^2),2)


FA2.ca.rpc <- FA2.ca$rowpcoord
cm <- colSums(FA2)/sum(FA2)
FA2.ca.ccc <- FA2.ca$colcoord * sqrt(cm)

# invert 1st axis
FA2.ca.rpc[,1] <- -FA2.ca.rpc[,1]
FA2.ca.ccc[,1] <- -FA2.ca.ccc[,1]

FA2.ca.ctr <- (FA2.ca.ccc[,1]^2 > 1/ncol(FA2)) | (FA2.ca.ccc[,2]^2 > 1/ncol(FA2)) 
names(FA2.ca.ctr) <- colnames(FA2)
sum(FA2.ca.ctr)


# force 20:5n-3 into the plot
FA2.ca.ctr["C20:5n-3"] <- TRUE

### function add.alpha:
add.alpha <- function(col, alpha=1){
  if(missing(col))
    stop("Please provide a vector of colours.")
  apply(sapply(col, col2rgb)/255, 2, 
        function(x) 
          rgb(x[1], x[2], x[3], alpha=alpha))  
}
### 
require(RColorBrewer)
species.col <- brewer.pal(3, "Dark2") # c("forestgreen","chocolate","purple) # green for "C", brown for "E"

species.col.alpha <- add.alpha(species.col, 0.8)

require(colorspace)
date.col <- rainbow_hcl(9)
require(RColorBrewer)
date.col <- c(brewer.pal(8, "Dark2"),brewer.pal(8,"Dark2")[1])
species.col.alpha <- add.alpha(species.col, 0.8)

# save as png insert into PPT, and eventually save all as png
#png(file="Fig_S6_left.png",width=7,height=5.5,units="in",res=144)

rescale <- 0.5 # for points
dim <- c(1,2)
col <- c("blue","red")
perc.hor <- 45.83; perc.ver <- 28.94
par(mar=c(4.2,4,2,2.5), mgp=c(2,0.7,0), font.lab=2, cex.axis=0.8)
plot(1.05 * rbind(FA2.ca.rpc, rescale*FA2.ca.ccc), type = "n", 
     asp = 1, xlab = paste("CA dimension ", dim[1], " (", 
                           round(perc.hor, 1), "%)", sep = ""), ylab = paste("CA dimension ", 
                                                                             dim[2], " (", round(perc.ver, 1), "%)", sep = ""), 
     xaxt = "n", yaxt = "n", main = "")
abline(h = 0, v = 0, col = "gray", lty = 2)
axis(1)
axis(2)
axis(3, at = axTicks(3), labels = round(axTicks(3)/rescale, 
                                        2), col = "black", col.ticks = col[2], col.axis = col[2])
axis(4, at = axTicks(4), labels = round(axTicks(4)/rescale, 
                                        2), col = "black", col.ticks = col[2], col.axis = col[2])

arrows(0, 0, 0.92 * rescale * FA2.ca.ccc[FA2.ca.ctr, 1], 0.92 * rescale * FA2.ca.ccc[FA2.ca.ctr, 2], 
       length = 0.1, angle = 10, col = "pink")
text(FA2.ca.rpc,  labels=paste(substr(species,1,1),dates.num, sep=""),
     col = date.col[dates.num],cex = 0.6, font=2)
text(rescale * FA2.ca.ccc[FA2.ca.ctr,], labels = colnames(FA2)[FA2.ca.ctr], col = "red", cex = 0.7, font = 4)    
legend("topright", legend=c("1 = 24/11/2020","2 = 15/01/2021","3 = 05/02/2021",
                           "4 = 18/03/2021","5 = 19/04/2021","6 = 04/05/2021","7 = 19/05/2021","8 = 08/06/2021"), 
       col=date.col, text.col=date.col, cex=0.8, text.font=2, title="E:Eudiaptomus", title.col="black")



```

## CA ONLY CYCLOPS

```{r echo=FALSE,fig.keep='all', fig.height = 8, fig.width = 8, fig.align = "center"}


library(tidyverse)
library(readxl)
library(easyCODA)
FA.dat <- read_excel("Data/FA data.xlsx", skip=1)

# Selection of data 
# selecting only % for the 3 species
CA.1 <- filter(FA.dat, Type=="%", Species == "Cyclops" ) %>%
  filter(Date != as.Date("2020-10-27"))

# Selecting only FA to keep in analysis + species,date, vial to make column
CA.1 <- CA.1[c(1,3,5,12:57)]

################### fixing dates
dates <- CA.1$Date
table(dates)

dates.num <- as.numeric(as.factor(dates))
table(dates.num)

dates.lev <- factor(as.factor(dates), levels=c("2020-11-24", "2021-01-15", "2021-02-05","2021-03-18", "2021-04-19", "2021-05-04", "2021-05-19", "2021-06-08" ))
table(dates.lev)

dates.num <- as.numeric(dates.lev)
table(dates.num)

####################

#make a value for numbers of vial (removing "EK")
num.1 <- str_sub(CA.1$Vial, 3, str_length(CA.1$Vial)-0)

species <- (CA.1$Species)
#  make species as numbers instead of characters
species.num <- as.numeric(as.factor(CA.1$Species))

# add first letter of Species with number of vial together
case.label <- paste(substr(CA.1$Species,1,1), num.1, sep="")

#make rownames the vial column
CA.1 <-CA.1 %>% remove_rownames %>% column_to_rownames(var="Vial")

# set case.label value as rownames
rownames(CA.1) <- case.label

#remove species & date column + FA with many 0's (9,10D16 and C20:1n-9, whch have too many zeros, also C19:0internalstandard)
ER <- CA.1[,-c(1,2,15, 23, 29)]

############################################# FANCY

### remove outlier C57 and re-analyse (not aplicable in eudiaptomus)

FA2E    <- ER
FA2E.ca <- CA(FA2E)
#PLOT.CA(FA2E.ca, map="contribution", axes.inv=c(1,-1), rescale=0.5)
################################################################################


### remove outlier C57 and re-analyse

FA2 <- ER
FA2.ca <- CA(FA2)
#PLOT.CA(FA2.ca, map="contribution", axes.inv=c(1,-1), rescale=1.666666)


### better graphics
round(100*FA2.ca$sv^2/sum(FA2.ca$sv^2),2)


FA2.ca.rpc <- FA2.ca$rowpcoord
cm <- colSums(FA2)/sum(FA2)
FA2.ca.ccc <- FA2.ca$colcoord * sqrt(cm)

# invert 1st axis
FA2.ca.rpc[,1] <- -FA2.ca.rpc[,1]
FA2.ca.ccc[,1] <- -FA2.ca.ccc[,1]

FA2.ca.ctr <- (FA2.ca.ccc[,1]^2 > 1/ncol(FA2)) | (FA2.ca.ccc[,2]^2 > 1/ncol(FA2)) 
names(FA2.ca.ctr) <- colnames(FA2)
sum(FA2.ca.ctr)

# force 20:5n-3 into the plot
FA2.ca.ctr["C20:5n-3"] <- TRUE

### function add.alpha:
add.alpha <- function(col, alpha=1){
  if(missing(col))
    stop("Please provide a vector of colours.")
  apply(sapply(col, col2rgb)/255, 2, 
        function(x) 
          rgb(x[1], x[2], x[3], alpha=alpha))  
}
### 
require(RColorBrewer)
species.col <- brewer.pal(3, "Dark2") # c("forestgreen","chocolate","purple) # green for "C", brown for "E"

species.col.alpha <- add.alpha(species.col, 0.8)

require(colorspace)
date.col <- rainbow_hcl(9)
require(RColorBrewer)
date.col <- c(brewer.pal(8, "Dark2"),brewer.pal(8,"Dark2")[1])
species.col.alpha <- add.alpha(species.col, 0.8)

# save as png insert into PPT, and eventually save all as png
#png(file="Fig_S6_left.png",width=7,height=5.5,units="in",res=144)

rescale <- 0.5 # for points
dim <- c(1,2)
col <- c("blue","red")
perc.hor <- 59.11; perc.ver <- 15.69
par(mar=c(4.2,4,2,2.5), mgp=c(2,0.7,0), font.lab=2, cex.axis=0.8)
plot(1.05 * rbind(FA2.ca.rpc, rescale*FA2.ca.ccc), type = "n", 
     asp = 1, xlab = paste("CA dimension ", dim[1], " (", 
                           round(perc.hor, 1), "%)", sep = ""), ylab = paste("CA dimension ", 
                                                                             dim[2], " (", round(perc.ver, 1), "%)", sep = ""), 
     xaxt = "n", yaxt = "n", main = "")
abline(h = 0, v = 0, col = "gray", lty = 2)
axis(1)
axis(2)
axis(3, at = axTicks(3), labels = round(axTicks(3)/rescale, 
                                        2), col = "black", col.ticks = col[2], col.axis = col[2])
axis(4, at = axTicks(4), labels = round(axTicks(4)/rescale, 
                                        2), col = "black", col.ticks = col[2], col.axis = col[2])

arrows(0, 0, 0.92 * rescale * FA2.ca.ccc[FA2.ca.ctr, 1], 0.92 * rescale * FA2.ca.ccc[FA2.ca.ctr, 2], 
       length = 0.1, angle = 10, col = "pink")
text(FA2.ca.rpc,  labels=paste(substr(species,1,1),dates.num, sep=""),
     col = date.col[dates.num],cex = 0.6, font=2)
text(rescale * FA2.ca.ccc[FA2.ca.ctr,], labels = colnames(FA2)[FA2.ca.ctr], col = "red", cex = 0.7, font = 4)    
legend("topleft", legend=c("1 = 24/11/2020","2 = 15/01/2021","3 = 05/02/2021",
                           "4 = 18/03/2021","5 = 19/04/2021","6 = 04/05/2021","7 = 19/05/2021","8 = 08/06/2021"), 
       col=date.col, text.col=date.col, cex=0.8, text.font=2, title="C:Cyclops", title.col="black")

##################################

FA.cca1<-cca(FA2~dates)		# add species and dates as explanatory variables
plot(FA.cca1,scaling=3)

anova(FA.cca1, by = "margin") #or by terms, margin, axis
```

## CA ONLY POM

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 8, fig.width = 8, fig.align = "center"}


library(tidyverse)
library(readxl)
library(easyCODA)
FA.dat <- read_excel("Data/FA data.xlsx", skip=1)

# Selection of data 
# selecting only % for the 3 species
CA.1 <- filter(FA.dat, Type=="%", Species == "POM" & Depth == "0-10" ) %>%
  filter(Date != as.Date("2020-10-27")) %>%
  filter(Date != as.Date("2021-06-30"))

# Selecting only FA to keep in analysis + species,date, vial to make column
CA.1 <- CA.1[c(1,3,5,12:57)]

################### fixing dates
dates <- CA.1$Date
table(dates)

dates.num <- as.numeric(as.factor(dates))
table(dates.num)

dates.lev <- factor(as.factor(dates), levels=c("2020-11-24", "2021-01-15", "2021-02-05","2021-03-18", "2021-04-19", "2021-05-04", "2021-05-19", "2021-06-08" ))
table(dates.lev)

dates.num <- as.numeric(dates.lev)
table(dates.num)

####################

#make a value for numbers of vial (removing "EK")
num.1 <- str_sub(CA.1$Vial, 3, str_length(CA.1$Vial)-0)

species <- (CA.1$Species)
#  make species as numbers instead of characters
species.num <- as.numeric(as.factor(CA.1$Species))

# add first letter of Species with number of vial together
case.label <- paste(substr(CA.1$Species,1,1), num.1, sep="")

#make rownames the vial column
CA.1 <-CA.1 %>% remove_rownames %>% column_to_rownames(var="Vial")

# set case.label value as rownames
rownames(CA.1) <- case.label

#remove species & date column + FA with many 0's (9,10D16 and C20:1n-9, which have too many zeros, also C19:0internalstandard)
ER <- CA.1[,-c(1,2,15, 23, 29)]

############################################# FANCY

### remove outlier C57 and re-analyse (not aplicable in eudiaptomus)

FA2E    <- ER
FA2E.ca <- CA(FA2E)
#PLOT.CA(FA2E.ca, map="contribution", axes.inv=c(1,-1), rescale=0.5)
################################################################################


### remove outlier C57 and re-analyse

FA2 <- ER
FA2.ca <- CA(FA2)
#PLOT.CA(FA2.ca, map="contribution", axes.inv=c(1,-1), rescale=1.666666)


### better graphics
round(100*FA2.ca$sv^2/sum(FA2.ca$sv^2),2)

FA2.ca.rpc <- FA2.ca$rowpcoord
cm <- colSums(FA2)/sum(FA2)
FA2.ca.ccc <- FA2.ca$colcoord * sqrt(cm)

# invert 1st axis
FA2.ca.rpc[,1] <- -FA2.ca.rpc[,1]
FA2.ca.ccc[,1] <- -FA2.ca.ccc[,1]

FA2.ca.ctr <- (FA2.ca.ccc[,1]^2 > 1/ncol(FA2)) | (FA2.ca.ccc[,2]^2 > 1/ncol(FA2)) 
names(FA2.ca.ctr) <- colnames(FA2)
sum(FA2.ca.ctr)

# force 20:5n-3 into the plot
FA2.ca.ctr["C20:5n-3"] <- TRUE

### function add.alpha:
add.alpha <- function(col, alpha=1){
  if(missing(col))
    stop("Please provide a vector of colours.")
  apply(sapply(col, col2rgb)/255, 2, 
        function(x) 
          rgb(x[1], x[2], x[3], alpha=alpha))  
}
### 
require(RColorBrewer)
species.col <- brewer.pal(3, "Dark2") # c("forestgreen","chocolate","purple) # green for "C", brown for "E"

species.col.alpha <- add.alpha(species.col, 0.8)

require(colorspace)
date.col <- rainbow_hcl(9)
require(RColorBrewer)
date.col <- c(brewer.pal(8, "Dark2"),brewer.pal(8,"Dark2")[1])
species.col.alpha <- add.alpha(species.col, 0.8)

# save as png insert into PPT, and eventually save all as png
#png(file="Fig_S6_left.png",width=7,height=5.5,units="in",res=144)

rescale <- 0.5 # for points
dim <- c(1,2)
col <- c("blue","red")
perc.hor <- 42.06; perc.ver <- 21.54
par(mar=c(4.2,4,2,2.5), mgp=c(2,0.7,0), font.lab=2, cex.axis=0.8)
plot(1.05 * rbind(FA2.ca.rpc, rescale*FA2.ca.ccc), type = "n", 
     asp = 1, xlab = paste("CA dimension ", dim[1], " (", 
                           round(perc.hor, 1), "%)", sep = ""), ylab = paste("CA dimension ", 
                                                                             dim[2], " (", round(perc.ver, 1), "%)", sep = ""), 
     xaxt = "n", yaxt = "n", main = "")
abline(h = 0, v = 0, col = "gray", lty = 2)
axis(1)
axis(2)
axis(3, at = axTicks(3), labels = round(axTicks(3)/rescale, 
                                        2), col = "black", col.ticks = col[2], col.axis = col[2])
axis(4, at = axTicks(4), labels = round(axTicks(4)/rescale, 
                                        2), col = "black", col.ticks = col[2], col.axis = col[2])

arrows(0, 0, 0.92 * rescale * FA2.ca.ccc[FA2.ca.ctr, 1], 0.92 * rescale * FA2.ca.ccc[FA2.ca.ctr, 2], 
       length = 0.1, angle = 10, col = "pink")
text(FA2.ca.rpc,  labels=paste(substr(species,1,1),dates.num, sep=""),
     col = date.col[dates.num],cex = 0.6, font=2)
text(rescale * FA2.ca.ccc[FA2.ca.ctr,], labels = colnames(FA2)[FA2.ca.ctr], col = "red", cex = 0.7, font = 4)    
legend("topleft", legend=c("1 = 24/11/2020","2 = 15/01/2021","3 = 05/02/2021",
                           "4 = 18/03/2021","5 = 19/04/2021","6 = 04/05/2021","7 = 19/05/2021","8 = 08/06/2021"), 
       col=date.col, text.col=date.col, cex=0.8, text.font=2, title="P: POM", title.col="black")

########################################### CCA
FA.cca1<-cca(FA2~dates)		# add species and dates as explanatory variables
plot(FA.cca1,scaling=3)

anova(FA.cca1, by = "margin") #or by terms, margin, axis

```

## CA ONLY EuDIAPTOMUS AND CYCLOPS (to appendix)

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 8, fig.width = 8, fig.align = "center"}


library(tidyverse)
library(readxl)
library(easyCODA)
FA.dat <- read_excel("Data/FA data.xlsx", skip=1)

# Selection of data 
# selecting only % for the 3 species
CA.1 <- filter(FA.dat, Type=="%", Species == "Eudiaptomus" |Species == "Cyclops" ) %>%
  filter(Date != as.Date("2020-10-27"))

# Selecting only FA to keep in analysis + species,date, vial to make column
CA.1 <- CA.1[c(1,3,5,12:57)]

################### fixing dates
dates <- CA.1$Date
table(dates)

dates.num <- as.numeric(as.factor(dates))
table(dates.num)

dates.lev <- factor(as.factor(dates), levels=c("2020-11-24", "2021-01-15", "2021-02-05","2021-03-18", "2021-04-19", "2021-05-04", "2021-05-19", "2021-06-08" ))
table(dates.lev)

dates.num <- as.numeric(dates.lev)
table(dates.num)

####################

#make a value for numbers of vial (removing "EK")
num.1 <- str_sub(CA.1$Vial, 3, str_length(CA.1$Vial)-0)

species <- (CA.1$Species)
#  make species as numbers instead of characters
species.num <- as.numeric(as.factor(CA.1$Species))

# add first letter of Species with number of vial together
case.label <- paste(substr(CA.1$Species,1,1), num.1, sep="")

#make rownames the vial column
CA.1 <-CA.1 %>% remove_rownames %>% column_to_rownames(var="Vial")

# set case.label value as rownames
rownames(CA.1) <- case.label

#remove species & date column + FA with many 0's (9,10D16 and C20:1n-9, whch have too many zeros, also C19:0internalstandard)
ER <- CA.1[,-c(1,2,15, 23, 29)]

############################################# FANCY

### remove outlier C57 and re-analyse (not aplicable in eudiaptomus)

FA2E    <- ER
FA2E.ca <- CA(FA2E)
#PLOT.CA(FA2E.ca, map="contribution", axes.inv=c(1,-1), rescale=0.5)
################################################################################


### remove outlier C57 and re-analyse

FA2 <- ER
FA2.ca <- CA(FA2)
PLOT.CA(FA2.ca, map="contribution", axes.inv=c(1,-1), rescale=1.666666)


### better graphics
round(100*FA2.ca$sv^2/sum(FA2.ca$sv^2),2)

FA2.ca.rpc <- FA2.ca$rowpcoord
cm <- colSums(FA2)/sum(FA2)
FA2.ca.ccc <- FA2.ca$colcoord * sqrt(cm)

# invert 1st axis
FA2.ca.rpc[,1] <- -FA2.ca.rpc[,1]
FA2.ca.ccc[,1] <- -FA2.ca.ccc[,1]

FA2.ca.ctr <- (FA2.ca.ccc[,1]^2 > 1/ncol(FA2)) | (FA2.ca.ccc[,2]^2 > 1/ncol(FA2)) 
names(FA2.ca.ctr) <- colnames(FA2)
sum(FA2.ca.ctr)

# force 20:5n-3 into the plot
FA2.ca.ctr["C20:5n-3"] <- TRUE

### function add.alpha:
add.alpha <- function(col, alpha=1){
  if(missing(col))
    stop("Please provide a vector of colours.")
  apply(sapply(col, col2rgb)/255, 2, 
        function(x) 
          rgb(x[1], x[2], x[3], alpha=alpha))  
}
### 
require(RColorBrewer)
species.col <- brewer.pal(3, "Dark2") # c("forestgreen","chocolate","purple) # green for "C", brown for "E"

species.col.alpha <- add.alpha(species.col, 0.8)

require(colorspace)
date.col <- rainbow_hcl(9)
require(RColorBrewer)
date.col <- c(brewer.pal(8, "Dark2"),brewer.pal(8,"Dark2")[1])
species.col.alpha <- add.alpha(species.col, 0.8)

# save as png insert into PPT, and eventually save all as png
#png(file="Fig_S6_left.png",width=7,height=5.5,units="in",res=144)

rescale <- 0.5 # for points
dim <- c(1,2)
col <- c("blue","red")
perc.hor <- 65.63; perc.ver <- 17.40
par(mar=c(4.2,4,2,2.5), mgp=c(2,0.7,0), font.lab=2, cex.axis=0.8)
plot(1.05 * rbind(FA2.ca.rpc, rescale*FA2.ca.ccc), type = "n", 
     asp = 1, xlab = paste("CA dimension ", dim[1], " (", 
                           round(perc.hor, 1), "%)", sep = ""), ylab = paste("CA dimension ", 
                                                                             dim[2], " (", round(perc.ver, 1), "%)", sep = ""), 
     xaxt = "n", yaxt = "n", main = "")
abline(h = 0, v = 0, col = "gray", lty = 2)
axis(1)
axis(2)
axis(3, at = axTicks(3), labels = round(axTicks(3)/rescale, 
                                        2), col = "black", col.ticks = col[2], col.axis = col[2])
axis(4, at = axTicks(4), labels = round(axTicks(4)/rescale, 
                                        2), col = "black", col.ticks = col[2], col.axis = col[2])

arrows(0, 0, 0.92 * rescale * FA2.ca.ccc[FA2.ca.ctr, 1], 0.92 * rescale * FA2.ca.ccc[FA2.ca.ctr, 2], 
       length = 0.1, angle = 10, col = "pink")
text(FA2.ca.rpc,  labels=paste(substr(species,1,1),dates.num, sep=""),
     col = date.col[dates.num],cex = 0.6, font=2)
text(rescale * FA2.ca.ccc[FA2.ca.ctr,], labels = colnames(FA2)[FA2.ca.ctr], col = "red", cex = 0.7, font = 4)    
legend("bottomleft", legend=c("1 = 24/11/2020","2 = 15/01/2021","3 = 05/02/2021",
                           "4 = 18/03/2021","5 = 19/04/2021","6 = 04/05/2021","7 = 19/05/2021","8 = 08/06/2021"), 
       col=date.col, text.col=date.col, cex=0.8, text.font=2, title="C:Cyclops E:Eudiaptomus", title.col="black")

################################################# CCA
FA.cca1<-cca(FA2~dates+species)		# add species and dates as explanatory variables
plot(FA.cca1,scaling=3)

anova(FA.cca1, by = "margin") #or by terms, margin, axis

```


# NOT WORKING
# not adjusted yet (might remove this for manuscript data)

# Extra plots

### Most likely in appendix

## Light data

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 4, fig.width = 8, fig.align = "center"}
#light data from handheld sensor (one with the cables)

library(readxl)
lighthand <- read_excel("C:/Users/Erwin/OneDrive/UIT/Data/light data handheld/handheld light sensors.xlsx")


lhand <- lighthand %>%
  mutate(Date=as.Date(Date)) %>%
  pivot_longer(., cols = "Light AIR":"Light water", names_to = "Type", values_to = "values")%>%
  mutate(Type = fct_reorder(Type, values, .fun="median",na.rm = TRUE)) %>%
ggplot(., aes(x= Date, y=values, fill= Type)) + 
  geom_bar(position = "dodge",stat="identity")+
  labs(title="light measurements", y = "um m2/s1")+
  scale_x_date(breaks="month", labels = scales::label_date("%b"),limits = as.Date(c('2020-10-20','2021-06-15')))

#layout options
  #theme_tufte()+
    #scale_fill_brewer(palette="Accent")

lhand
```

## barplot fatty acids

Shows fatty acid composition per sample. only for the major contributing fatty acids

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 4, fig.width = 8, fig.align = "center"}
library(dplyr)
library(readxl)
library(viridis)
library(RColorBrewer)
library(tidyverse)
library(cowplot)

FA_data <- read_excel("C:/Users/Erwin/OneDrive/Manuscript Erwin Kers/R script + data/Manuscript-1.0/Data/FA data.xlsx", skip=1)

#Subset 1 species
bar <- subset(FA_data, Type=="%" & Species=="Cyclops")
bar$Date <- as.Date(bar$Date)

#transform to long data frame

DFtall <- bar %>% pivot_longer(cols= (c(12,13,19,22,26,29,30,35,39,41,47,49,52,56,57)), names_to = "FA", values_to = "value")


# Stacked bar plot Cyclops seperated per individual sample
Bar1 <-ggplot(DFtall, aes(fill=FA, y=value, x= interaction(Vial,Date,sep = "&"))) + 
  geom_bar(position="stack", stat="identity")+
  labs(title="Cyclops", y = "%")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# Eudiaptomus --------------------------------------------

bar <- subset(FA_data, Type=="%" & Species=="Eudiaptomus")
bar$Date <- as.Date(bar$Date)

#transform to long data frame
DFtall <- bar %>% pivot_longer(cols= (c(12,13,19,22,26,29,30,35,39,41,47,52,57)), names_to = "FA", values_to = "value")

# Stacked bar plot Eudiaptomus seperated per individual sample
Bar2 <-ggplot(DFtall, aes(fill=FA, y=value, x= interaction(Vial,Date, sep = "&"))) + 
  geom_bar(position="stack", stat="identity")+
  labs(title="Eudiaptomus", y = "%")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))



# POM --------------------------------------------

bar <- subset(FA_data, Type=="%" & Species=="POM")
bar$Date <- as.Date(bar$Date)

#transform to long data frame
DFtall <- bar %>% pivot_longer(cols= (c(12,13,19,22,26,29,30,35,39,41,47,52,57)), names_to = "FA", values_to = "value")

# Stacked POM
Bar3 <- ggplot(DFtall, aes(fill=FA, y=value, x=interaction(Vial,Date,Depth, sep = "&"))) + 
  geom_bar(stat="identity")+
  labs(title="POM", y = "%")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

Bar1
Bar2
Bar3



```

Plot grid (removed)

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 7, fig.width = 6, fig.align = "center"}
plot_grid(FALIN,FALIN2,ncol=1,align = "v")
```

Plot grid Zooplankton (remov)

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 8, fig.width = 6, fig.align = "center"}
plot_grid(E,C,N,ncol=1,align = "v")
```

## Fatty acid table

Symbols aren't right in R markdown but are fine in a normal plot, but the general idea is visible.

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 4, fig.width = 8, fig.align = "center"}
#pretty fa table
library(tidyverse)
library(gt)
library(readxl)
library(dplyr)
library(lubridate)


FA <- read_excel("C:/Users/Erwin/OneDrive/Manuscript Erwin Kers/R script + data/Manuscript-1.0/Data/FA data.xlsx", skip=1)
#str(FA$Date)

FA2 <- FA %>%
  select(1,3,7,8,11:57) %>%
  filter(Species!="Bulk tracers" , Species!="Blank", Type=="%") %>%
  group_by(Date,Species)%>%
  mutate(Date2 = as.Date(Date,format="%d-%m-%Y"))%>%
  summarise_all(funs(sum(!is.na(.)),mean,sd),na.rm=TRUE)%>%
  select(1,2,3,52:152)%>%
  mutate(across(where(is.numeric), round, 2))%>%
  rename(replicates = "Tot_lipids_sum")%>%
  unite("Tot_lipids","Tot_lipids_mean" : "Tot_lipids_stdev_mean",sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C14:0",starts_with("C14:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("iso-15:0",starts_with("iso-15:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("anteiso-15:0",starts_with("anteiso-15:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C14:1n-5",starts_with("C14:1n-5"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C15:0",starts_with("C15:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("iso-16:0",starts_with("iso-16:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C15:1n-5",starts_with("C15:1n-5"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C16:0",starts_with("C16:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("iso-17:0",starts_with("iso-17:0"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C16:1n-9",starts_with("C16:1n-9"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C16:1n-7",starts_with("C16:1n-7"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C17:0",starts_with("C17:0"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("9,10D16",starts_with("9,10D16"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C17:1n-7",starts_with("C17:1n-7"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:0",starts_with("C18:0"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:1n-9trans",starts_with("C18:1n-9trans"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:1n-12",starts_with("C18:1n-12"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:1n-9cis",starts_with("C18:1n-9cis"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:1n-7",starts_with("C18:1n-7"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:1n-6",starts_with("C18:1n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C19:0",starts_with("C19:0"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:2n-6trans",starts_with("C18:2n-6trans"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("9,10D18",starts_with("9,10D18"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:2n-6cis (LIN)",starts_with("C18:2n-6cis (LIN)"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C20:0",starts_with("C20:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C18:3n-6",starts_with("C18:3n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:1n-9",starts_with("C20:1n-9"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C18:3n-3 (ALA)",starts_with("C18:3n-3 (ALA)"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C21:0",starts_with("C21:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C18:4n-3",starts_with("C18:4n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:2n-6",starts_with("C20:2n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:0",starts_with("C22:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:3n-6",starts_with("C20:3n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:1n-9",starts_with("C22:1n-9"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:3n-3",starts_with("C20:3n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:4n-6",starts_with("C20:4n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C23:0",starts_with("C23:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:4n-3",starts_with("C20:4n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:2n-6",starts_with("C22:2n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C24:0",starts_with("C24:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:5n-3",starts_with("C20:5n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C24:1n-9",starts_with("C24:1n-9"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:3n-3",starts_with("C22:3n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:4n-6",starts_with("C22:4n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:5n-3",starts_with("C22:5n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:6n-3",starts_with("C22:6n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  select(-Type_mean,-Type_sd,-Tot_lipids_sd,-Tot_lipids_stdev_sd)
  

# making the table  


# Create a gt table 

FA2 %>%
  gt(rowname_col = "Species",
     groupname_col = "Date") %>%
  tab_header(
    title = "Fatty acid contribution")%>%
  cols_label( Species = md("**Species**")) %>%
  cols_label( Date = md("**Date**")) %>%
cols_align(
  align = "center",
  columns = c("replicates":"C22:6n-3")
)%>%
cols_align(
  align = "left",
  columns = c(Species)
)%>%
  cols_width(
    everything() ~ px(100)
  ) 

FA2


FA %>%
  select(1,3,7,8,11:57) %>%
  filter(Species!="Bulk tracers" , Species!="Blank", Type=="µg FAME/mg dw") %>%
  group_by(Date,Species)%>%
  mutate(Date2 = as.Date(Date,format="%d-%m-%Y"))%>%
  summarise_all(funs(sum(!is.na(.)),mean,sd),na.rm=TRUE)%>%
  select(1,2,3,52:152)%>%
  mutate(across(where(is.numeric), round, 2))%>%
  rename(replicates = "Tot_lipids_sum")%>%
  unite("Tot_lipids","Tot_lipids_mean" : "Tot_lipids_stdev_mean",sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C14:0",starts_with("C14:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("iso-15:0",starts_with("iso-15:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("anteiso-15:0",starts_with("anteiso-15:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C14:1n-5",starts_with("C14:1n-5"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C15:0",starts_with("C15:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("iso-16:0",starts_with("iso-16:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C15:1n-5",starts_with("C15:1n-5"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C16:0",starts_with("C16:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("iso-17:0",starts_with("iso-17:0"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C16:1n-9",starts_with("C16:1n-9"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C16:1n-7",starts_with("C16:1n-7"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C17:0",starts_with("C17:0"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("9,10D16",starts_with("9,10D16"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C17:1n-7",starts_with("C17:1n-7"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:0",starts_with("C18:0"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:1n-9trans",starts_with("C18:1n-9trans"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:1n-12",starts_with("C18:1n-12"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:1n-9cis",starts_with("C18:1n-9cis"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:1n-7",starts_with("C18:1n-7"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:1n-6",starts_with("C18:1n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C19:0",starts_with("C19:0"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:2n-6trans",starts_with("C18:2n-6trans"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("9,10D18",starts_with("9,10D18"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C18:2n-6cis (LIN)",starts_with("C18:2n-6cis (LIN)"),sep= "±",na.rm = TRUE, remove = T)%>%
unite("C20:0",starts_with("C20:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C18:3n-6",starts_with("C18:3n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:1n-9",starts_with("C20:1n-9"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C18:3n-3 (ALA)",starts_with("C18:3n-3 (ALA)"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C21:0",starts_with("C21:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C18:4n-3",starts_with("C18:4n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:2n-6",starts_with("C20:2n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:0",starts_with("C22:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:3n-6",starts_with("C20:3n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:1n-9",starts_with("C22:1n-9"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:3n-3",starts_with("C20:3n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:4n-6",starts_with("C20:4n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C23:0",starts_with("C23:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:4n-3",starts_with("C20:4n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:2n-6",starts_with("C22:2n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C24:0",starts_with("C24:0"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C20:5n-3",starts_with("C20:5n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C24:1n-9",starts_with("C24:1n-9"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:3n-3",starts_with("C22:3n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:4n-6",starts_with("C22:4n-6"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:5n-3",starts_with("C22:5n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  unite("C22:6n-3",starts_with("C22:6n-3"),sep= "±",na.rm = TRUE, remove = T)%>%
  select(-Type_mean,-Type_sd,-Tot_lipids_sd,-Tot_lipids_stdev_sd)
```

## Chi square distance POM to zooplankton

```{r echo=T, fig.height = 8, fig.width = 8, fig.align = "center"}


library(tidyverse)
library(readxl)
library(easyCODA)
library(ggdendro)
FA.dat <- read_excel("C:/Users/Erwin/OneDrive/Manuscript Erwin Kers/R script + data/Manuscript-1.0/Data/FA data.xlsx", skip=1)

# Selection of data 
# selecting only % for the 3 species
CA.1 <- filter(FA.dat, Type=="%", Species == "Eudiaptomus" |Species == "Cyclops" |Species == "POM" & Depth == "0-10") %>%
  filter(Date != as.Date("2020-10-27"))

# Selecting only FA to keep in analysis + species,date, vial to make column
CA.1 <- CA.1[c(1,3,5,12:57)]

#remove species & date column + FA with many 0's (9,10D16 and C20:1n-9, whch have too many zeros, also C19:0internalstandard)
ER <- CA.1[,-c(16, 24, 30)]

# aggregate table by group and date FA
CA.1 <- ER %>%
  group_by(Species, Date) %>%
  summarise_at(vars(4:44), list(mean = mean))

################### fixing dates
dates <- CA.1$Date
table(dates)

dates.num <- as.numeric(as.factor(dates))
table(dates.num)

dates.lev <- factor(as.factor(dates), levels=c("2020-11-24", "2021-01-15", "2021-02-05","2021-03-18", "2021-04-19", "2021-05-04", "2021-05-19", "2021-06-08" ))
table(dates.lev)

dates.num <- as.numeric(dates.lev)
table(dates.num)

####################
#make a value for numbers of vial (removing "EK")
num.1 <- str_sub(CA.1$Date, 3, str_length(CA.1$Date)-0)


species <- (CA.1$Species)
#  make species as numbers instead of characters
species.num <- as.numeric(as.factor(CA.1$Species))

# add first letter of Species with number of vial together
case.label <- paste(substr(CA.1$Species,1,1), num.1, sep="")

# set case.label value as rownames

CA.1<- CA.1[,-c(1,2)]

fa.m <- CA.1
rownames(fa.m) <- case.label
####################################################### chi square distance
library(analogue)

# calculations of chi-square distances for abundances of species a,b,c,d,e 
rowpro <- fa.m/apply(fa.m,1,sum) 
avepro<-apply(fa.m,2,sum)/sum(fa.m)

chid <-dist(as.matrix(rowpro)%*%diag(1/sqrt(avepro)) ) # calculate chi-square distances


chid
chidata <- as.matrix(chid)
# using package same results
# how to change 1,2,3 etc to row names?
distance(fa.m, method = "chi.distance", weights = NULL,
         R = F, dist = T, double.zero = T)


#the agglomeration method to be used. This should be (an unambiguous abbreviation of) one of "ward.D", "ward.D2", "single", "complete", "average" (= UPGMA), "mcquitty" (= WPGMA), "median" (= WPGMC) or "centroid" (= UPGMC).
#which method to use?

Chi2_distance <- 
  distance(fa.m, method = "chi.distance", weights = NULL,
           R = F, dist = T, double.zero = T)
Chi2_distance


dend <- hclust(Chi2_distance, method = "ward.D")
as.dendrogram(dend)
plot(dend, type = "rectangle", ylab = "Height")


#with ggplot
#ggdendrogram(dend)

list(case.label)

########## for loop to select only POM compared to Cyclops and eudiaptomus for the same date

as.matrix(chid)[17,1]

FAd<-matrix(0,8,2)
for(j in 1:2){
for (i in 1:8) {
FAd[i,j]<-as.matrix(chid)[(i+16),((j-1)*8+i)]
      print(as.matrix(chid)[(i+16),((j-1)*8+i)])
  }
}

chi2d<-as.data.frame(FAd)
names(chi2d) <- c("Cyclops", "Eudiaptomus")
chi2d$date <- c("2020-11-24", "2021-01-15", "2021-02-05","2021-03-18", "2021-04-19", "2021-05-04", "2021-05-19", "2021-06-08" )

########## for loop to select only POM compared to Cyclops and eudiaptomus for the next date

as.matrix(chid)[17,1]

FAd<-matrix(0,8,2)
for(j in 1:2){
for (i in 1:8) {
FAd[i,j]<-as.matrix(chid)[(i+15),((j-1)*8+i)]
      print(as.matrix(chid)[(i+15),((j-1)*8+i)])
  }
}

# chi square distance from mean POM to mean Cyclops and scutifer per date
# POM comapred to next date for zooplankton (1 month delay)
chi2d.delay<-as.data.frame(FAd)
names(chi2d) <- c("Cyclops", "Eudiaptomus")
row.names(chi2d) <- c("2020-11-24", "2021-01-15", "2021-02-05","2021-03-18", "2021-04-19", "2021-05-04", "2021-05-19", "2021-06-08" )

#### saving chi2 to excel file


write_xlsx(chi2d,"C:/Users/Erwin/OneDrive/UIT/Data/chi distance/chi2.xlsx")

```

## Combined plot for thesis (previous ones are for a more detailed look)

I can't figure out how I can add the break from the nutrient plot (due to high silica levels) to the combined plot. Somehow it disappears, if you know how to do this please let me know :)

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 8, fig.width = 8, fig.align = "center"}
library(ggbreak)
plot_grid(condbar,lhand,barnut2,ncol=1,align = "v")

```

```{r echo=FALSE,results='hide',fig.keep='all', fig.height = 8, fig.width = 8, fig.align = "center"}
library(ggbreak)
plot_grid(condbar,lhand,barnut2,chlbar,ncol=1,align = "v")

```
